name: JoyJoin CI/CD Pipeline

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}/api

jobs:
  lint:
    name: Lint & Type Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: Install dependencies
        run: npm ci
      - name: Type check user-client
        run: cd apps/user-client && npx tsc --noEmit
      - name: Type check admin-client
        run: cd apps/admin-client && npx tsc --noEmit
      - name: Type check server
        run: cd apps/server && npx tsc --noEmit

  test:
    name: Run Tests
    needs: lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: Install dependencies
        run: npm ci
      - name: Run AI Chat Flow Tests
        run: npx tsx apps/server/src/tests/runSimulation.ts 100
        env:
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}

  build-user:
    name: Build User Portal
    needs: test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: Install root dependencies
        run: npm ci
      - name: Build User Client
        run: |
          cd apps/user-client
          npx vite build
        env:
          VITE_API_URL: ${{ vars.API_URL }}
      - name: Upload User Build
        uses: actions/upload-artifact@v4
        with:
          name: user-client-build
          path: apps/user-client/dist
          retention-days: 7

  build-admin:
    name: Build Admin Portal
    needs: test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: Install root dependencies
        run: npm ci
      - name: Build Admin Client
        run: |
          cd apps/admin-client
          npx vite build
        env:
          VITE_API_URL: ${{ vars.API_URL }}
      - name: Upload Admin Build
        uses: actions/upload-artifact@v4
        with:
          name: admin-client-build
          path: apps/admin-client/dist
          retention-days: 7

  build-api:
    name: Build API Docker Image
    needs: test
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=sha,prefix=
            type=ref,event=branch
            type=semver,pattern={{version}}
      
      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: .
          file: apps/server/Dockerfile
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.meta.outputs.tags }}

  deploy-staging:
    name: Deploy to Staging
    needs:
      - build-user
      - build-admin
      - build-api
    if: github.ref == 'refs/heads/develop'
    runs-on: ubuntu-latest
    environment:
      name: staging
      url: https://staging.joyjoin.com
    steps:
      - uses: actions/checkout@v4
      - name: Download User Build
        uses: actions/download-artifact@v4
        with:
          name: user-client-build
          path: apps/user-client/dist
      - name: Download Admin Build
        uses: actions/download-artifact@v4
        with:
          name: admin-client-build
          path: apps/admin-client/dist
      - name: Deploy User Portal to Staging
        run: echo "Deploying user portal to staging CDN..."
      - name: Deploy Admin Portal to Staging
        run: echo "Deploying admin portal to staging CDN..."
      - name: Deploy API to Staging
        run: echo "Deploying API container to staging..."

  deploy-production:
    name: Deploy to Production
    needs:
      - build-user
      - build-admin
      - build-api
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    environment:
      name: production
      url: https://app.joyjoin.com
    steps:
      - uses: actions/checkout@v4
      - name: Download User Build
        uses: actions/download-artifact@v4
        with:
          name: user-client-build
          path: apps/user-client/dist
      - name: Download Admin Build
        uses: actions/download-artifact@v4
        with:
          name: admin-client-build
          path: apps/admin-client/dist
      - name: Run Database Migrations
        run: echo "Running database migrations..."
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
      - name: Deploy User Portal
        run: echo "Deploying user portal to production CDN..."
      - name: Deploy Admin Portal
        run: echo "Deploying admin portal to production CDN..."
      - name: Deploy API
        run: echo "Deploying API container to production..."
