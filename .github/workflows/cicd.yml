name: JoyJoin Production Pipeline

on:
  push:
    branches: [ main ]

jobs:
  # Lint jobs ä¿æŒä¸å˜...
  lint-user:
    name: Type Check User Client
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
      - name: Install dependencies
        run: npm ci
      - name: Run TSC
        run: npx tsc -p apps/user-client/tsconfig.json --noEmit

  lint-admin:
    name: Type Check Admin Client
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
      - name: Install dependencies
        run: npm ci
      - name: Run TSC
        run: npx tsc -p apps/admin-client/tsconfig.json --noEmit

  lint-server:
    name: Type Check Server
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
      - name: Install dependencies
        run: npm ci
      - name: Run TSC
        run: npx tsc -p apps/server/tsconfig.json --noEmit

  ai-test:
    name: AI Simulation Test
    needs: [lint-user, lint-admin, lint-server]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
      - name: Install dependencies
        run: npm ci
      - name: Run Simulation
        run: npx tsx apps/server/src/tests/runSimulation.ts 100
        env:
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}

  deploy:
    name: Production Deployment
    needs: ai-test
    runs-on: ubuntu-latest
    steps:
      - name: SSH Remote Deployment
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          command_timeout: 30m 
          script: |
            set -e # ä»»ä½•å‘½ä»¤å‡ºé”™ç«‹å³åœæ­¢ï¼Œé˜²æ­¢è¿é”ååº”
            
            # --- 1. Code Sync ---
            echo "ğŸ“¥ Syncing code..."
            cd ~/JoyJoin
            git fetch --all
            git reset --hard origin/main
            
            # --- 2. Docker Services ---
            echo "ğŸ³ Restarting containers..."
            cd deployment
            
            # Caddy å®‰å…¨é‡å¯æ¨¡å¼ï¼šä¸åˆ å®¹å™¨ï¼Œåªçƒ­æ›´æ–°
            docker compose -f docker-compose.caddy.yml up -d --build --remove-orphans
            
            # --- 3. Database Sync ---
            echo "ğŸ”§ Fixing DNS and syncing database..."
            echo "nameserver 8.8.8.8" | sudo tee /etc/resolv.conf > /dev/null
            
            cd ~/JoyJoin
            # ç¡¬ç¼–ç  DB è¿æ¥ (Turn 15 éªŒè¯é€šè¿‡ç‰ˆ)
            export DATABASE_URL="postgresql://neondb_owner:npg_NmTv6SY3fxXW@ep-square-math-ahiz6fm7-pooler.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require"
            echo "ğŸ¯ Target DB: $(echo $DATABASE_URL | sed 's/:[^@]*@/:****@/')"
            npx drizzle-kit push --config=./drizzle.config.ts
            
            # --- 4. Health Checks (å¤±è´¥åˆ™å›æ»šçš„å‰æ) ---
            echo "ğŸ¥ Verifying service status..."
            sleep 30 
            
            # æ£€æŸ¥å†…éƒ¨ API
            echo "   Checking internal API..."
            curl -s --retry 5 --retry-delay 5 http://localhost:5000 > /dev/null || (echo "âŒ API Failed" && docker logs joyjoin-api --tail 50 && exit 1)
            
            # æ£€æŸ¥å¤–éƒ¨ HTTPS (é˜²å‡æˆåŠŸ)
            echo "   Checking Public Access (via Caddy)..."
            if ! curl -s -k -f --retry 5 --retry-delay 5 https://localhost > /dev/null; then
                echo "âŒ Website Check Failed! Caddy issue or Backend Error."
                echo "ğŸ” Caddy Logs:"
                docker logs joyjoin-caddy --tail 20
                
                # ğŸ”´ å…³é”®ç‚¹ï¼šå¦‚æœè¿™é‡Œå¤±è´¥äº†ï¼Œè„šæœ¬ç›´æ¥ exit 1ã€‚
                # ä¸‹é¢çš„æ¸…ç†å‘½ä»¤å°±ä¸ä¼šæ‰§è¡Œï¼Œä½ çš„æ—§é•œåƒä¾ç„¶åœ¨ç¡¬ç›˜ä¸Šï¼Œæ–¹ä¾¿ä½ æ‰‹åŠ¨å›æ»šã€‚
                exit 1
            fi
            
            # --- 5. Smart Clean Up (ä¿ç•™æœ€è¿‘çš„å¤‡ä»½) ---
            echo "ğŸ§¹ Cleaning up OLD Docker images (Safety Mode)..."
            
            # [CRITICAL UPDATE] 
            # åªåˆ é™¤ 24 å°æ—¶ä¹‹å‰åˆ›å»ºçš„æœªä½¿ç”¨é•œåƒã€‚
            # è¿™æ ·åˆšæ‰æ›¿æ¢ä¸‹æ¥çš„é‚£ä¸ªæ—§ç‰ˆæœ¬ï¼ˆBuild time < 24hï¼‰ä¼šè¢«ä¿ç•™ï¼
            # å¦‚æœä½ éœ€è¦å›æ»šï¼Œæœ¬åœ°è¿˜æœ‰é•œåƒå¯ç”¨ã€‚
            docker image prune -a --force --filter "until=24h"
            
            # æ¸…ç†æ— ç”¨çš„åŒ¿åå· (Volume)ï¼Œé‡Šæ”¾æ•°æ®åº“ç¢ç‰‡ç©ºé—´
            docker volume prune -f
            
            echo "âœ… Deployment successful!"
