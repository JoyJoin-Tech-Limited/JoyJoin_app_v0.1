name: JoyJoin Production Pipeline

on:
  push:
    branches: [ main ]

# ÈÅøÂÖçÂêå‰∏ÄÂàÜÊîØÂπ∂ÂèëË∑ëÂ§öÊ¨°ÔºàÂèØÈÄâÔºå‰ΩÜÂæàÂ∏∏ËßÅÔºâ
concurrency:
  group: joyjoin-prod-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lint-user:
    name: Type Check User Client
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: package-lock.json

      - name: Debug workspace + lockfile
        run: |
          set -e
          echo "PWD=$(pwd)"
          echo "WORKSPACE=$GITHUB_WORKSPACE"
          echo "---- root listing ----"
          ls -la
          echo "---- lockfiles (maxdepth=4) ----"
          find . -maxdepth 4 \( -name "package-lock.json" -o -name "npm-shrinkwrap.json" \) -print
          test -f package-lock.json || (echo "‚ùå package-lock.json NOT FOUND at repo root" && exit 1)

      - name: Install dependencies
        run: npm ci

      - name: Run TSC
        run: npx tsc -p apps/user-client/tsconfig.json --noEmit

  lint-admin:
    name: Type Check Admin Client
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: package-lock.json

      - name: Debug workspace + lockfile
        run: |
          set -e
          echo "PWD=$(pwd)"
          echo "WORKSPACE=$GITHUB_WORKSPACE"
          echo "---- root listing ----"
          ls -la
          echo "---- lockfiles (maxdepth=4) ----"
          find . -maxdepth 4 \( -name "package-lock.json" -o -name "npm-shrinkwrap.json" \) -print
          test -f package-lock.json || (echo "‚ùå package-lock.json NOT FOUND at repo root" && exit 1)

      - name: Install dependencies
        run: npm ci

      - name: Run TSC
        run: npx tsc -p apps/admin-client/tsconfig.json --noEmit

  lint-server:
    name: Type Check Server
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: package-lock.json

      - name: Debug workspace + lockfile
        run: |
          set -e
          echo "PWD=$(pwd)"
          echo "WORKSPACE=$GITHUB_WORKSPACE"
          echo "---- root listing ----"
          ls -la
          echo "---- lockfiles (maxdepth=4) ----"
          find . -maxdepth 4 \( -name "package-lock.json" -o -name "npm-shrinkwrap.json" \) -print
          test -f package-lock.json || (echo "‚ùå package-lock.json NOT FOUND at repo root" && exit 1)

      - name: Install dependencies
        run: npm ci

      - name: Run TSC
        run: npx tsc -p apps/server/tsconfig.json --noEmit

  ai-test:
    name: AI Simulation Test
    needs: [lint-user, lint-admin, lint-server]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: package-lock.json

      - name: Debug workspace + lockfile
        run: |
          set -e
          echo "PWD=$(pwd)"
          echo "WORKSPACE=$GITHUB_WORKSPACE"
          echo "---- root listing ----"
          ls -la
          echo "---- lockfiles (maxdepth=4) ----"
          find . -maxdepth 4 \( -name "package-lock.json" -o -name "npm-shrinkwrap.json" \) -print
          test -f package-lock.json || (echo "‚ùå package-lock.json NOT FOUND at repo root" && exit 1)

      - name: Install dependencies
        run: npm ci

      - name: Run Simulation
        run: npx tsx apps/server/src/tests/runSimulation.ts 100
        env:
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}

  deploy:
    name: Production Deployment
    needs: ai-test
    runs-on: ubuntu-latest
    steps:
      - name: SSH Remote Deployment
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          command_timeout: 30m
          script: |
            set -e # ‰ªª‰ΩïÂëΩ‰ª§Âá∫ÈîôÁ´ãÂç≥ÂÅúÊ≠¢

            # --- 1. Code Sync ---
            echo "üì• Syncing code..."
            cd ~/JoyJoin
            git fetch --all
            git reset --hard origin/main

            # --- 2. Docker Services ---
            echo "üê≥ Restarting containers..."
            cd deployment

            # Caddy ÂÆâÂÖ®ÈáçÂêØ
            docker compose -f docker-compose.caddy.yml up -d --build --remove-orphans

            # --- 3. Database Sync ---
            echo "üîß Fixing DNS and syncing database..."
            echo "nameserver 8.8.8.8" | sudo tee /etc/resolv.conf > /dev/null

            cd ~/JoyJoin
            # Á°¨ÁºñÁ†Å DB ËøûÊé•
            export DATABASE_URL="postgresql://neondb_owner:npg_NmTv6SY3fxXW@ep-square-math-ahiz6fm7-pooler.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require"
            echo "üéØ Target DB: $(echo $DATABASE_URL | sed 's/:[^@]*@/:****@/')"
            npx drizzle-kit push --config=./drizzle.config.ts

            # --- 4. Health Checks ---
            echo "üè• Verifying service status..."
            sleep 15

            echo "   Checking internal API..."
            curl -s --retry 5 --retry-delay 5 http://localhost:5000 > /dev/null || (echo "‚ùå API Failed" && docker logs joyjoin-api --tail 50 && exit 1)

            echo "   Checking Caddy Container status..."
            if [ "$(docker inspect -f '{{.State.Running}}' joyjoin-caddy)" != "true" ]; then
                echo "‚ùå Caddy is NOT running."
                docker logs joyjoin-caddy --tail 20
                exit 1
            fi

            # --- 5. Smart Clean Up ---
            echo "üßπ Cleaning up OLD Docker images (Safety Mode)..."
            docker image prune -a --force --filter "until=24h"
            docker volume prune -f

            echo "‚úÖ Deployment successful!"

