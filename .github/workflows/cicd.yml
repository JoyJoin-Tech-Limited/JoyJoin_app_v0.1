name: JoyJoin CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}/api

jobs:
  # ============ Lint & Type Check ============
  lint:
    name: Lint & Type Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Type check
        run: npm run check

  # ============ Run Tests ============
  test:
    name: Run Tests
    needs: lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run AI Chat Flow Tests
        run: npx tsx server/tests/runSimulation.ts 100
        env:
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}

  # ============ Build User Portal ============
  build-user:
    name: Build User Portal
    needs: test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build User Client
        run: npm run build:user
        env:
          VITE_API_URL: ${{ vars.API_URL }}
      
      - name: Upload User Build
        uses: actions/upload-artifact@v4
        with:
          name: user-client-build
          path: dist/user-client
          retention-days: 7

  # ============ Build Admin Portal ============
  build-admin:
    name: Build Admin Portal
    needs: test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build Admin Client
        run: npm run build:admin
        env:
          VITE_API_URL: ${{ vars.API_URL }}
      
      - name: Upload Admin Build
        uses: actions/upload-artifact@v4
        with:
          name: admin-client-build
          path: dist/admin-client
          retention-days: 7

  # ============ Build & Push API Docker Image ============
  build-api:
    name: Build API Docker Image
    needs: test
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4
      
      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=sha,prefix=
            type=ref,event=branch
            type=semver,pattern={{version}}
      
      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          file: apps/server/Dockerfile
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

  # ============ Deploy to Staging ============
  deploy-staging:
    name: Deploy to Staging
    needs: [build-user, build-admin, build-api]
    if: github.ref == 'refs/heads/develop'
    runs-on: ubuntu-latest
    environment:
      name: staging
      url: https://staging.joyjoin.com
    steps:
      - uses: actions/checkout@v4
      
      - name: Download User Build
        uses: actions/download-artifact@v4
        with:
          name: user-client-build
          path: dist/user-client
      
      - name: Download Admin Build
        uses: actions/download-artifact@v4
        with:
          name: admin-client-build
          path: dist/admin-client
      
      - name: Deploy User Portal to Staging
        run: |
          echo "Deploying user portal to staging CDN..."
          # Add your deployment command here, e.g.:
          # npx vercel deploy dist/user-client --prod --token=${{ secrets.VERCEL_TOKEN }}
      
      - name: Deploy Admin Portal to Staging
        run: |
          echo "Deploying admin portal to staging CDN..."
          # Add your deployment command here
      
      - name: Deploy API to Staging
        run: |
          echo "Deploying API container to staging..."
          # Add your deployment command here, e.g.:
          # flyctl deploy --image ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}

  # ============ Deploy to Production ============
  deploy-production:
    name: Deploy to Production
    needs: [build-user, build-admin, build-api]
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    environment:
      name: production
      url: https://app.joyjoin.com
    steps:
      - uses: actions/checkout@v4
      
      - name: Download User Build
        uses: actions/download-artifact@v4
        with:
          name: user-client-build
          path: dist/user-client
      
      - name: Download Admin Build
        uses: actions/download-artifact@v4
        with:
          name: admin-client-build
          path: dist/admin-client
      
      - name: Run Database Migrations
        run: |
          echo "Running database migrations..."
          # npm run db:push
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
      
      - name: Deploy User Portal
        run: |
          echo "Deploying user portal to production CDN..."
          # npx vercel deploy dist/user-client --prod --token=${{ secrets.VERCEL_TOKEN }}
      
      - name: Deploy Admin Portal
        run: |
          echo "Deploying admin portal to production CDN..."
          # npx vercel deploy dist/admin-client --prod --token=${{ secrets.VERCEL_TOKEN }}
      
      - name: Deploy API
        run: |
          echo "Deploying API container to production..."
          # flyctl deploy --image ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
