# JoyJoin Caddy Configuration
# æ™ºèƒ½ç½‘å…³ + è‡ªåŠ¨ HTTPS + è·¨å­åŸŸåèº«ä»½å…±äº«
# 
# éƒ¨ç½²è¯´æ˜:
# 1. ç¡®ä¿ DNS A è®°å½•æŒ‡å‘æœåŠ¡å™¨ IP:
#    - yuejuapp.com -> æœåŠ¡å™¨IP
#    - www.yuejuapp.com -> æœåŠ¡å™¨IP  
#    - api.yuejuapp.com -> æœåŠ¡å™¨IP
#    - admin.yuejuapp.com -> æœåŠ¡å™¨IP
# 2. Caddy ä¼šè‡ªåŠ¨ç”³è¯· Let's Encrypt SSL è¯ä¹¦
# 3. æ‰€æœ‰ HTTP è¯·æ±‚è‡ªåŠ¨é‡å®šå‘åˆ° HTTPS

# ç”¨æˆ·ç«¯ (ä¸»åŸŸå + www)
yuejuapp.com, www.yuejuapp.com {
    encode gzip

    header {
        X-Content-Type-Options nosniff
        X-Frame-Options DENY
        Referrer-Policy strict-origin-when-cross-origin
    }

    reverse_proxy joyjoin-user:80 {
        header_up X-Forwarded-Proto https
        header_up X-Forwarded-Host {host}
        header_up X-Forwarded-For {remote}
    }
}

# ç®¡ç†åå° (admin å­åŸŸå)
admin.yuejuapp.com {
    encode gzip

    header {
        X-Content-Type-Options nosniff
        X-Frame-Options DENY
        Referrer-Policy strict-origin-when-cross-origin
    }

    reverse_proxy joyjoin-admin:80 {
        header_up X-Forwarded-Proto https
        header_up X-Forwarded-Host {host}
        header_up X-Forwarded-For {remote}
    }
}

# åç«¯æ¥å£ (api å­åŸŸå)
api.yuejuapp.com {
    encode gzip

    header {
        X-Content-Type-Options nosniff
        X-Frame-Options SAMEORIGIN
        Referrer-Policy strict-origin-when-cross-origin
        Access-Control-Allow-Credentials true
    }

    @cors_preflight method OPTIONS
    handle @cors_preflight {
        header Access-Control-Allow-Origin "{header.Origin}"
        header Access-Control-Allow-Methods "GET, POST, PUT, PATCH, DELETE, OPTIONS"
        header Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With"
        header Access-Control-Max-Age "86400"
        respond "" 204
    }

    reverse_proxy joyjoin-api:5000 {
        # ğŸ”§ FIX: Caddy is TLS terminator, so force https (don't preserve incoming header)
        header_up X-Forwarded-Proto https
        header_up X-Forwarded-Host {host}
        header_up X-Forwarded-For {remote}
    }
}
