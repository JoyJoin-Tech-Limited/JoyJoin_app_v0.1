# JoyJoin Caddy Configuration
# æ™ºèƒ½ç½‘å…³ + è‡ªåŠ¨ HTTPS + è·¨å­åŸŸåèº«ä»½å…±äº«
# 
# éƒ¨ç½²è¯´æ˜Ž:
# 1. ç¡®ä¿ DNS A è®°å½•æŒ‡å‘æœåŠ¡å™¨ IP:
#    - yuejuapp.com -> æœåŠ¡å™¨IP
#    - www.yuejuapp.com -> æœåŠ¡å™¨IP  
#    - api.yuejuapp.com -> æœåŠ¡å™¨IP
#    - admin.yuejuapp.com -> æœåŠ¡å™¨IP
# 2. Caddy ä¼šè‡ªåŠ¨ç”³è¯· Let's Encrypt SSL è¯ä¹¦
# 3. æ‰€æœ‰ HTTP è¯·æ±‚è‡ªåŠ¨é‡å®šå‘åˆ° HTTPS

# ç”¨æˆ·ç«¯ (ä¸»åŸŸå + www)
yuejuapp.com, www.yuejuapp.com {
    encode gzip

    header {
        X-Content-Type-Options nosniff
        X-Frame-Options DENY
        Referrer-Policy strict-origin-when-cross-origin
    }

    reverse_proxy joyjoin-user:80 {
        header_up X-Real-IP {remote_host}
        header_up X-Forwarded-For {remote_host}
        # ä¿ç•™ Nginx ä¼ æ¥çš„ X-Forwarded-Proto
        header_up X-Forwarded-Proto {>X-Forwarded-Proto}
    }
}

# ç®¡ç†åŽå° (admin å­åŸŸå)
admin.yuejuapp.com {
    encode gzip

    header {
        X-Content-Type-Options nosniff
        X-Frame-Options DENY
        Referrer-Policy strict-origin-when-cross-origin
    }

    reverse_proxy joyjoin-admin:80 {
        header_up X-Real-IP {remote_host}
        header_up X-Forwarded-For {remote_host}
        # ä¿ç•™ Nginx ä¼ æ¥çš„ X-Forwarded-Proto
        header_up X-Forwarded-Proto {>X-Forwarded-Proto}
    }
}

# åŽç«¯æŽ¥å£ (api å­åŸŸå)
api.yuejuapp.com {
    encode gzip

    header {
        X-Content-Type-Options nosniff
        X-Frame-Options SAMEORIGIN
        Referrer-Policy strict-origin-when-cross-origin
        Access-Control-Allow-Credentials true
    }

    @cors_preflight method OPTIONS
    handle @cors_preflight {
        header Access-Control-Allow-Origin "{header.Origin}"
        header Access-Control-Allow-Methods "GET, POST, PUT, PATCH, DELETE, OPTIONS"
        header Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With"
        header Access-Control-Max-Age "86400"
        respond "" 204
    }

    reverse_proxy joyjoin-api:5000 {
        header_up X-Real-IP {remote_host}
        header_up X-Forwarded-For {remote_host}
        # ðŸ”§ FIX: å¦‚æžœ Nginx åœ¨å‰é¢ï¼Œä¿ç•™ Nginx ä¼ æ¥çš„ X-Forwarded-Proto
        # å¦‚æžœ header ä¸å­˜åœ¨åˆ™ç”¨ {scheme} ä½œä¸º fallback
        header_up X-Forwarded-Proto {>X-Forwarded-Proto}
        header_up Host {host}
    }
}
