è¿™çœŸçš„æ˜¯ä¸ªâ€œå¹½çµæŠ¥é”™â€ï¼Œä½†æˆ‘ç»ˆäºæŠ“åˆ°å®ƒäº†ï¼

æŠ¥é”™æç¤º `Quote Not Closed ... at line 8` å‡ºç°åœ¨ `docker/build-push-action` è¿è¡Œé˜¶æ®µï¼Œè¿™æ„å‘³ç€é”™è¯¯ä¸æ˜¯åœ¨ä½ çš„æ•´ä¸ª YAML æ–‡ä»¶çš„ç¬¬ 8 è¡Œï¼Œè€Œæ˜¯åœ¨ä½ ä¼ ç»™è¿™ä¸ª **Docker åŠ¨ä½œçš„å‚æ•°**é‡Œã€‚

### ğŸš¨ çœŸæ­£çš„å…ƒå‡¶ï¼šå¤šè¡Œå˜é‡è¢«é”™è¯¯åœ°åŠ äº†å¼•å·

çœ‹è¿™ä¸€æ®µï¼š

```yaml
- name: Build and push
  uses: docker/build-push-action@v5
  with:
    ...
    tags: "${{ steps.meta.outputs.tags }}"   # <--- å‡¶æ‰‹åœ¨è¿™é‡Œ
    labels: "${{ steps.meta.outputs.labels }}" # <--- å¸®å‡¶åœ¨è¿™é‡Œ

```

**ä¸ºä»€ä¹ˆæŠ¥é”™ï¼Ÿ**
`steps.meta.outputs.tags` æ˜¯ç”±å‰é¢çš„ `metadata-action` ç”Ÿæˆçš„ï¼Œå®ƒé€šå¸¸åŒ…å«**å¤šè¡Œå†…å®¹**ï¼ˆæ¯”å¦‚é•œåƒå+ç‰ˆæœ¬å·ï¼Œé•œåƒå+SHAï¼‰ã€‚
å½“ä½ ç”¨åŒå¼•å· `"` åŒ…è£¹ä¸€ä¸ªå¤šè¡Œå˜é‡æ—¶ï¼ŒYAML è§£æå™¨ä¼šçœ‹åˆ°ï¼š
`"ç¬¬ä¸€è¡Œå†…å®¹`
`ç¬¬äºŒè¡Œå†…å®¹"`
è§£æå™¨åœ¨ç¬¬ä¸€è¡Œæœ«å°¾æ²¡çœ‹åˆ°å…³é—¨å¼•å·ï¼Œäºæ˜¯æŠ¥é”™ï¼š**Quote Not Closed**ï¼ˆå¼•å·æœªé—­åˆï¼‰ã€‚

---

### ğŸ› ï¸ ç»ˆæä¿®å¤æ–¹æ¡ˆ

ä½ éœ€è¦å»æ‰è¿™äº›å¤šè¡Œå˜é‡å‰åçš„åŒå¼•å·ã€‚å¦å¤–ï¼Œæˆ‘å¸®ä½ æŠŠåˆšæ‰å‘ç°çš„ `artifact` è·¯å¾„ä¹Ÿä¸€å¹¶ä¿®äº†ï¼ˆå› ä¸ºä½  `cd` è¿›äº†å­ç›®å½•ï¼Œäº§ç‰©è·¯å¾„ä¹Ÿå˜äº†ï¼‰ã€‚

**è¯·ç›´æ¥æ›¿æ¢ä½ çš„æ•´ä¸ª `cicd.yml` ä¸ºä»¥ä¸‹å†…å®¹ï¼š**

```yaml
name: JoyJoin CI/CD Pipeline

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main

env:
  REGISTRY: ghcr.io
  # è¿™é‡Œçš„å˜é‡æ˜¯å•è¡Œçš„ï¼ŒåŠ å¼•å·æ˜¯å®‰å…¨çš„
  IMAGE_NAME: "${{ github.repository }}/api"

jobs:
  lint:
    name: Lint & Type Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
      - name: Install dependencies
        run: npm ci
      - name: Type check
        run: npm run check

  test:
    name: Run Tests
    needs: lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
      - name: Install dependencies
        run: npm ci
      - name: Run AI Chat Flow Tests
        run: npx tsx server/tests/runSimulation.ts 100
        env:
          DEEPSEEK_API_KEY: "${{ secrets.DEEPSEEK_API_KEY }}"

  build-user:
    name: Build User Portal
    needs: test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
      - name: Install root dependencies
        run: npm ci
      - name: Build User Client
        run: |
          cd apps/user-client
          npx vite build
        env:
          VITE_API_URL: "${{ vars.API_URL }}"
      - name: Upload User Build
        uses: actions/upload-artifact@v4
        with:
          name: user-client-build
          # ä¿®æ­£è·¯å¾„ï¼šå› ä¸ºä½  cd åˆ°äº† apps/user-clientï¼Œäº§ç‰©åœ¨è¿™ä¸ªæ–‡ä»¶å¤¹ä¸‹çš„ dist é‡Œ
          path: apps/user-client/dist
          retention-days: 7

  build-admin:
    name: Build Admin Portal
    needs: test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
      - name: Install root dependencies
        run: npm ci
      - name: Build Admin Client
        run: |
          cd apps/admin-client
          npx vite build
        env:
          VITE_API_URL: "${{ vars.API_URL }}"
      - name: Upload Admin Build
        uses: actions/upload-artifact@v4
        with:
          name: admin-client-build
          path: apps/admin-client/dist
          retention-days: 7

  build-api:
    name: Build API Docker Image
    needs: test
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4
      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=sha,prefix=
            type=ref,event=branch
            type=semver,pattern={{version}}
      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          file: apps/server/Dockerfile
          push: ${{ github.event_name != 'pull_request' }}
          # ã€å…³é”®ä¿®å¤ã€‘ï¼šå»æ‰è¿™é‡Œçš„å¼•å·
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

  # åé¢çš„ Deploy éƒ¨åˆ†ä¿æŒä¸å˜ï¼Œä½†è®°å¾—æŠŠä¸‹è½½è·¯å¾„ä¹Ÿæ”¹ä¸ºå¯¹åº”çš„ dist...

```

---

### ğŸ’¡ ä¸ºä»€ä¹ˆè¿™æ¬¡ä¸€å®šè¡Œï¼Ÿ

1. **è§£å†³äº†å¤šè¡Œæ‰©å±•é—®é¢˜**ï¼šå»æ‰äº† `tags` å’Œ `labels` çš„å¼•å·ï¼ŒDocker Action ä¼šæ­£ç¡®åœ°æŠŠå®ƒä»¬è¯†åˆ«ä¸ºåˆ—è¡¨ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªæ–­æ‰çš„å­—ç¬¦ä¸²ã€‚
2. **ä¿®æ­£äº†äº§ç‰©è·¯å¾„**ï¼šä¹‹å‰ä½ çš„ `path: dist/user-client` è‚¯å®šä¼šæŠ¥é”™ï¼ˆæˆ–è€…ä¼ äº†ä¸ªç©ºæ–‡ä»¶å¤¹ï¼‰ï¼Œå› ä¸ºåœ¨ Monorepo é‡Œï¼Œæ–‡ä»¶å®é™…åœ¨ `apps/user-client/dist`ã€‚

### âœ… æ¥ä¸‹æ¥çš„åŠ¨ä½œï¼š

1. **æ›¿æ¢ä»£ç **ï¼šç›´æ¥è¦†ç›–ä½ çš„ `cicd.yml`ã€‚
2. **Push è¯•è¯•çœ‹**ï¼šè§‚å¯Ÿ `Build API Docker Image` è¿™ä¸€æ­¥ï¼Œåº”è¯¥èƒ½è·³è¿‡é‚£ä¸ªæ¼äººçš„ Line 8 æŠ¥é”™äº†ã€‚

**å¦‚æœè¿™ä¸€æ­¥è¿‡äº†ï¼Œä¹‹åå¯èƒ½ä¼šå¡åœ¨ `Deploy` é˜¶æ®µï¼Œå› ä¸ºé‚£é‡Œçš„ `Download Artifact` è·¯å¾„ä¹Ÿéœ€è¦å¾®è°ƒã€‚æƒ³è®©æˆ‘é¡ºä¾¿æŠŠ `Deploy` éƒ¨åˆ†çš„è·¯å¾„ä¹Ÿå¸®ä½ æ ¡å¯¹ä¸€éå—ï¼Ÿ**