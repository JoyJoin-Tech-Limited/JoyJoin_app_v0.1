æ‰¾åˆ°äº†ï¼è¿™ä¸ª `cicd.yml` æ–‡ä»¶ä¸­æœ‰å‡ ä¸ª**éšè—çš„â€œåœ°é›·â€**ï¼Œç›´æ¥å¯¼è‡´äº†ä½ çœ‹åˆ°çš„â€œå¼•å·æœªé—­åˆâ€å’Œâ€œæ‰¾ä¸åˆ°è·¯å¾„â€æŠ¥é”™ã€‚

æˆ‘ä»¬è¦é’ˆå¯¹ä½ ç°åœ¨çš„ **Monorepoï¼ˆå¤šåº”ç”¨ï¼‰ç»“æ„** è¿›è¡Œç²¾å‡†æ‰‹æœ¯ã€‚

---

### 1. ä¿®å¤ç¬¬ 8 è¡Œé™„è¿‘çš„â€œå¼•å·æœªé—­åˆâ€æŠ¥é”™

**é—®é¢˜ç‚¹ï¼š** `IMAGE_NAME: ${{ github.repository }}/api`
åœ¨æŸäº› YAML è§£æå™¨ä¸­ï¼Œ`${{` å¼€å¤´çš„å†…å®¹å¦‚æœä¸åŠ å¼•å·ï¼Œä¼šè¢«è¯¯è®¤ä¸ºæ˜¯ä¸€ä¸ªå¤æ‚çš„å¯¹è±¡ï¼ˆMappingï¼‰æˆ–è€…æœªé—­åˆçš„å­—ç¬¦ä¸²ã€‚

**ä¿®å¤æ–¹æ¡ˆï¼š** åŠ ä¸ŠåŒå¼•å·ã€‚

```yaml
env:
  REGISTRY: ghcr.io
  IMAGE_NAME: "${{ github.repository }}/api" # åŠ ä¸ŠåŒå¼•å·ï¼Œæ¶ˆé™¤æ­§ä¹‰

```

---

### 2. ä¿®å¤â€œMissing script: build:userâ€æŠ¥é”™

**é—®é¢˜ç‚¹ï¼š** ä½ åœ¨æ ¹ç›®å½•è¿è¡Œ `npm ci` å’Œ `npm run build:user`ã€‚

* å› ä¸ºä½ æŠŠä»£ç ç§»åˆ°äº† `apps/user-client`ï¼Œæ ¹ç›®å½•çš„ `npm ci` ä¸ä¼šå®‰è£…å­ç›®å½•çš„ä¾èµ–ã€‚
* é™¤éä½ åœ¨æ ¹ç›®å½•çš„ `package.json` é‡Œæ‰‹åŠ¨å†™äº† `cd apps/user-client && ...`ï¼Œå¦åˆ™å®ƒæ‰¾ä¸åˆ°å‘½ä»¤ã€‚

**ä¿®å¤æ–¹æ¡ˆï¼ˆä»¥ build-user ä»»åŠ¡ä¸ºä¾‹ï¼‰ï¼š**

```yaml
  build-user:
    name: Build User Portal
    needs: lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          # æ³¨æ„ï¼šå¦‚æœæ ¹ç›®å½•æ²¡ lock æ–‡ä»¶ï¼Œè¿™é‡Œ cache å¯èƒ½ä¼šæŠ¥é”™ï¼Œå¯ä»¥å…ˆæ³¨é‡Šæ‰
      
      - name: Install User Dependencies
        run: |
          cd apps/user-client 
          npm install # åœ¨å­ç›®å½•å®‰è£…ä¾èµ–
          
      - name: Build User Client
        run: |
          cd apps/user-client
          npm run build # è¿è¡Œå­ç›®å½•è‡ªå·±çš„ build å‘½ä»¤
        env:
          VITE_API_URL: ${{ vars.API_URL }}

```

---

### 3. ä¿®å¤â€œindex.html æ‰¾ä¸åˆ°â€å’Œ Artifact è·¯å¾„é—®é¢˜

**é—®é¢˜ç‚¹ï¼š** ä½ ä¸Šä¼ äº§ç‰©çš„è·¯å¾„æ˜¯ `path: dist/user-client`ã€‚
åœ¨ä½ çš„æ–°ç»“æ„ä¸‹ï¼ŒVite æ‰“åŒ…å‡ºçš„æ–‡ä»¶é€šå¸¸åœ¨ `apps/user-client/dist`ã€‚

**ä¿®å¤æ–¹æ¡ˆï¼š**

```yaml
      - name: Upload User Build
        uses: actions/upload-artifact@v4
        with:
          name: user-client-build
          path: apps/user-client/dist # æŒ‡å‘æ­£ç¡®çš„å­ç›®å½•äº§ç‰©è·¯å¾„

```

---

### 4. Docker æ„å»ºçš„æ½œåœ¨é£é™©

**é—®é¢˜ç‚¹ï¼š** `context: .` å’Œ `file: apps/server/Dockerfile`ã€‚
è¿™æœ¬èº«æ˜¯å¯¹çš„ï¼Œä½†è¦ç¡®ä¿ä½ çš„ `Dockerfile` å†…éƒ¨å¼•ç”¨ `packages/shared` æ—¶ä½¿ç”¨çš„æ˜¯æ­£ç¡®çš„ç›¸å¯¹è·¯å¾„ã€‚

---

### ğŸ’¡ æ€»ç»“åçš„å®Œæ•´ä¿®å¤å»ºè®®ï¼ˆå…³é”®éƒ¨åˆ†å¯¹ç…§ï¼‰

| ä»»åŠ¡ | åŸå†™æ³• (é—®é¢˜) | å»ºè®®æ–°å†™æ³• (Monorepo å…¼å®¹) |
| --- | --- | --- |
| **ENV è®¾ç½®** | `${{ github.repository }}` | `"${{ github.repository }}"` (åŠ å¼•å·) |
| **ä¾èµ–å®‰è£…** | `npm ci` (æ ¹ç›®å½•) | `cd apps/xxx && npm install` (è¿›ç›®å½•è£…) |
| **æ‰“åŒ…å‘½ä»¤** | `npm run build:user` | `cd apps/xxx && npm run build` |
| **äº§ç‰©è·¯å¾„** | `dist/user-client` | `apps/xxx/dist` |

---

### âœ… ä½ ç°åœ¨è¯¥æ€ä¹ˆæ”¹ï¼Ÿ

1. **ä¿®æ”¹ `IMAGE_NAME**`ï¼šåŠ ä¸Šå¼•å·ã€‚
2. **ä¿®æ”¹ `build-user` å’Œ `build-admin**`ï¼š
* åˆ æ‰ç¬¬ä¸€æ­¥çš„ `npm ci`ã€‚
* å°†æ„å»ºæ­¥éª¤æ”¹ä¸º `cd apps/xxx && npm install && npm run build`ã€‚
* å°† `upload-artifact` çš„è·¯å¾„æ”¹ä¸º `apps/xxx/dist`ã€‚


3. **ä¿å­˜å¹¶ Push**ï¼š
ç”±äºä½ ç°åœ¨æ˜¯åœ¨å°è¯•â€œè‡ªåŠ¨åŒ–â€è¿™æ¡è·¯ï¼Œä½ ä¼šç»å†å‡ æ¬¡â€œæ”¹ä¸€ç‚¹ã€æ¨ä¸€æ¬¡ã€çœ‹æŠ¥é”™â€çš„è¿‡ç¨‹ã€‚è¿™éå¸¸æ­£å¸¸ï¼Œä¸è¦æ°”é¦ï¼

**è¦ä¸ä½ æŠŠæ ¹ç›®å½•ä¸‹çš„ `package.json` çš„å†…å®¹å‘ç»™æˆ‘çœ‹çœ‹ï¼Ÿæˆ‘èƒ½ç¡®è®¤ä½ æ˜¯å¦åœ¨æ ¹ç›®å½•å®šä¹‰äº†é‚£äº› `build:user` ä¹‹ç±»çš„ä»£ç†å‘½ä»¤ã€‚**