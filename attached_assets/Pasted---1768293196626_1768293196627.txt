# ç€‘å¸ƒæµå›¾ç‰‡å…´è¶£é€‰æ‹©åŠŸèƒ½å®Œæ•´æŠ€æœ¯æ–¹æ¡ˆ

## ä¸€ã€ç³»ç»Ÿæ¶æ„è®¾è®¡

### æ•´ä½“æ¶æ„
```
ç”¨æˆ·ç«¯(å¾®ä¿¡å°ç¨‹åº) â†â†’ ç½‘å…³/è´Ÿè½½å‡è¡¡ â†â†’ å¾®æœåŠ¡é›†ç¾¤
      â†“                       â†“              â†“
    CDN(å›¾ç‰‡)           APIæœåŠ¡å±‚         AIåˆ†ææœåŠ¡
                                â†“              â†“
                           ä¸šåŠ¡é€»è¾‘å±‚      å‘é‡æ•°æ®åº“
                                â†“              â†“
                           æ•°æ®å­˜å‚¨å±‚      åŒ¹é…ç®—æ³•
```

## äºŒã€å‰ç«¯å®ç°æ–¹æ¡ˆ

### 1. æ ¸å¿ƒäº¤äº’ç»„ä»¶

#### å›¾ç‰‡ç€‘å¸ƒæµç»„ä»¶
```javascript
// components/InterestWaterfall/InterestWaterfall.js
Component({
  properties: {
    images: Array,        // å›¾ç‰‡æ•°æ®
    totalTime: Number,    // æ€»æ—¶é•¿(ç§’)
    autoPlay: Boolean     // æ˜¯å¦è‡ªåŠ¨æ’­æ”¾
  },

  data: {
    currentIndex: 0,      // å½“å‰å›¾ç‰‡ç´¢å¼•
    userChoices: [],      // ç”¨æˆ·é€‰æ‹©è®°å½•
    timer: null,          // è‡ªåŠ¨æ’­æ”¾å®šæ—¶å™¨
    startTime: null,      // å¼€å§‹æ—¶é—´
    progress: 0,          // è¿›åº¦(0-100)
    swipeLock: false      // é˜²è¿å‡»é”
  },

  lifetimes: {
    attached() {
      this.initWaterfall();
    },
    
    detached() {
      this.cleanup();
    }
  },

  methods: {
    // åˆå§‹åŒ–ç€‘å¸ƒæµ
    initWaterfall() {
      this.setData({ startTime: Date.now() });
      
      if (this.properties.autoPlay) {
        this.startAutoPlay();
      }
    },

    // å¯åŠ¨è‡ªåŠ¨æ’­æ”¾
    startAutoPlay() {
      const { totalTime, images } = this.properties;
      const interval = (totalTime * 1000) / images.length;
      
      const timer = setInterval(() => {
        const nextIndex = this.data.currentIndex + 1;
        
        if (nextIndex >= images.length) {
          this.finishSelection();
          return;
        }
        
        // è®°å½•æœªå“åº”é€‰æ‹©
        this.recordChoice(this.data.currentIndex, 'no_response', interval);
        
        this.setData({
          currentIndex: nextIndex,
          progress: ((nextIndex + 1) / images.length) * 100
        });
        
      }, interval);
      
      this.setData({ timer });
    },

    // å¤„ç†æ»‘åŠ¨æ‰‹åŠ¿
    handleSwipe(e) {
      if (this.data.swipeLock) return;
      
      const direction = e.detail.direction;
      const imageIndex = this.data.currentIndex;
      const reactionTime = Date.now() - this.data.imageStartTime;
      
      // è®¾ç½®é˜²è¿å‡»é”
      this.setData({ swipeLock: true });
      
      // è®°å½•é€‰æ‹©
      let choice;
      switch(direction) {
        case 'right': choice = 'like'; break;
        case 'left': choice = 'skip'; break;
        case 'up': choice = 'love'; break;
        default: choice = 'unknown';
      }
      
      this.recordChoice(imageIndex, choice, reactionTime);
      
      // åŠ¨ç”»æ•ˆæœ
      this.animateSwipe(direction, () => {
        this.switchToNextImage();
        setTimeout(() => {
          this.setData({ swipeLock: false });
        }, 100);
      });
    },

    // è®°å½•ç”¨æˆ·é€‰æ‹©
    recordChoice(imageIndex, choice, reactionTime) {
      const { images } = this.properties;
      const imageData = images[imageIndex];
      
      const choiceRecord = {
        imageId: imageData.id,
        category: imageData.category,
        subCategory: imageData.subCategory,
        choice: choice,
        reactionTime: reactionTime,
        timestamp: Date.now()
      };
      
      const userChoices = [...this.data.userChoices];
      userChoices[imageIndex] = choiceRecord;
      
      this.setData({ userChoices });
      
      // å®æ—¶ä¸ŠæŠ¥é€‰æ‹©æ•°æ®
      this.reportChoice(choiceRecord);
    },

    // åˆ‡æ¢åˆ°ä¸‹ä¸€å¼ å›¾ç‰‡
    switchToNextImage() {
      const nextIndex = this.data.currentIndex + 1;
      
      if (nextIndex >= this.properties.images.length) {
        this.finishSelection();
        return;
      }
      
      this.setData({
        currentIndex: nextIndex,
        imageStartTime: Date.now(),
        progress: ((nextIndex + 1) / this.properties.images.length) * 100
      });
    },

    // åŠ¨ç”»æ•ˆæœ
    animateSwipe(direction, callback) {
      const animation = wx.createAnimation({
        duration: 300,
        timingFunction: 'ease-out'
      });
      
      switch(direction) {
        case 'right':
          animation.translateX(500).opacity(0).step();
          break;
        case 'left':
          animation.translateX(-500).opacity(0).step();
          break;
        case 'up':
          animation.translateY(-500).scale(0.8).opacity(0).step();
          break;
      }
      
      this.setData({
        swipeAnimation: animation.export()
      });
      
      setTimeout(() => {
        callback && callback();
      }, 250);
    },

    // å®Œæˆé€‰æ‹©
    finishSelection() {
      clearInterval(this.data.timer);
      
      const totalTime = Date.now() - this.data.startTime;
      const selectionData = {
        choices: this.data.userChoices,
        totalTime: totalTime,
        imagesSeen: this.data.currentIndex + 1
      };
      
      // è§¦å‘å®Œæˆäº‹ä»¶
      this.triggerEvent('complete', selectionData);
    },

    // æ¸…ç†èµ„æº
    cleanup() {
      clearInterval(this.data.timer);
    }
  }
});
```

#### æ‰‹åŠ¿è¯†åˆ«ç»„ä»¶
```javascript
// components/SwipeDetector/SwipeDetector.js
Component({
  methods: {
    handleTouchStart(e) {
      this.startX = e.touches[0].clientX;
      this.startY = e.touches[0].clientY;
      this.startTime = Date.now();
    },

    handleTouchMove(e) {
      if (!this.startX || !this.startY) return;
      
      const currentX = e.touches[0].clientX;
      const currentY = e.touches[0].clientY;
      
      // è®¡ç®—ç§»åŠ¨è·ç¦»
      const deltaX = currentX - this.startX;
      const deltaY = currentY - this.startY;
      
      // è§¦å‘å®æ—¶åé¦ˆ
      this.triggerEvent('swiping', { deltaX, deltaY });
    },

    handleTouchEnd(e) {
      if (!this.startX || !this.startY) return;
      
      const endX = e.changedTouches[0].clientX;
      const endY = e.changedTouches[0].clientY;
      const endTime = Date.now();
      
      const deltaX = endX - this.startX;
      const deltaY = endY - this.startY;
      const deltaTime = endTime - this.startTime;
      
      // è®¡ç®—ç§»åŠ¨è·ç¦»å’Œé€Ÿåº¦
      const distance = Math.sqrt(deltaX * deltaX + deltaY * deltaY);
      const velocity = distance / deltaTime;
      
      // åˆ¤æ–­æ‰‹åŠ¿æ–¹å‘
      let direction = null;
      const minDistance = 50; // æœ€å°æ»‘åŠ¨è·ç¦»
      const minVelocity = 0.3; // æœ€å°é€Ÿåº¦
      
      if (distance > minDistance && velocity > minVelocity) {
        const angle = Math.atan2(deltaY, deltaX) * 180 / Math.PI;
        
        if (angle >= -45 && angle <= 45) {
          direction = 'right'; // å³æ»‘
        } else if (angle >= 135 || angle <= -135) {
          direction = 'left'; // å·¦æ»‘
        } else if (angle > 45 && angle < 135) {
          direction = 'up'; // ä¸Šæ»‘
        }
      }
      
      if (direction) {
        this.triggerEvent('swipe', { direction, velocity, distance });
      }
      
      // é‡ç½®
      this.startX = null;
      this.startY = null;
      this.startTime = null;
    }
  }
});
```

### 2. é¡µé¢å®ç°

```javascript
// pages/interest-selection/interest-selection.js
Page({
  data: {
    images: [],           // å›¾ç‰‡åˆ—è¡¨
    isLoading: true,      // åŠ è½½çŠ¶æ€
    showTutorial: true,   // æ˜¾ç¤ºæ•™ç¨‹
    selectionComplete: false
  },

  onLoad() {
    this.loadImages();
    this.initAnalytics();
  },

  // åŠ è½½å›¾ç‰‡æ•°æ®
  async loadImages() {
    try {
      // 1. æ£€æŸ¥æœ¬åœ°ç¼“å­˜
      const cachedImages = wx.getStorageSync('interest_images');
      const cacheTime = wx.getStorageSync('interest_images_time');
      
      // 2. å¦‚æœç¼“å­˜æœ‰æ•ˆï¼ˆ1å¤©å†…ï¼‰ä¸”æ•°é‡è¶³å¤Ÿï¼Œä½¿ç”¨ç¼“å­˜
      const isCacheValid = cachedImages && 
                          cacheTime && 
                          (Date.now() - cacheTime < 24 * 60 * 60 * 1000) &&
                          cachedImages.length >= 15;
      
      if (isCacheValid) {
        this.setData({
          images: this.shuffleArray(cachedImages).slice(0, 18),
          isLoading: false
        });
      } else {
        // 3. ä»æœåŠ¡å™¨åŠ è½½
        const response = await wx.request({
          url: 'https://api.yourdomain.com/v1/images/interests',
          method: 'GET',
          header: {
            'Authorization': `Bearer ${getApp().globalData.token}`
          }
        });
        
        if (response.data.success) {
          const images = response.data.images;
          
          // ç¼“å­˜å›¾ç‰‡æ•°æ®
          wx.setStorageSync('interest_images', images);
          wx.setStorageSync('interest_images_time', Date.now());
          
          this.setData({
            images: this.shuffleArray(images).slice(0, 18),
            isLoading: false
          });
        }
      }
      
      // 4. é¢„åŠ è½½å›¾ç‰‡
      this.preloadImages();
      
    } catch (error) {
      console.error('åŠ è½½å›¾ç‰‡å¤±è´¥:', error);
      this.showError();
    }
  },

  // é¢„åŠ è½½å›¾ç‰‡
  preloadImages() {
    const { images } = this.data;
    
    images.forEach((image, index) => {
      const imgTask = wx.createSelectorQuery()
        .select(`#image-${index}`)
        .node()
        .exec((res) => {
          if (res[0] && res[0].node) {
            res[0].node.src = image.url;
          }
        });
    });
  },

  // å¼€å§‹é€‰æ‹©
  startSelection() {
    this.setData({ showTutorial: false });
    
    // å‘é€å¼€å§‹äº‹ä»¶åˆ°ç»„ä»¶
    this.selectComponent('#waterfall').startAutoPlay();
  },

  // å¤„ç†é€‰æ‹©å®Œæˆ
  handleSelectionComplete(e) {
    const selectionData = e.detail;
    
    this.setData({ selectionComplete: true });
    
    // æäº¤æ•°æ®åˆ°åç«¯
    this.submitSelection(selectionData);
    
    // è·³è½¬åˆ°ç»“æœé¡µé¢
    setTimeout(() => {
      wx.redirectTo({
        url: '/pages/matching/matching'
      });
    }, 1500);
  },

  // æäº¤é€‰æ‹©æ•°æ®
  async submitSelection(data) {
    try {
      const response = await wx.request({
        url: 'https://api.yourdomain.com/v1/selection/submit',
        method: 'POST',
        header: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${getApp().globalData.token}`
        },
        data: {
          userId: getApp().globalData.userId,
          selection: data.choices,
          metadata: {
            totalTime: data.totalTime,
            deviceInfo: this.getDeviceInfo(),
            sessionId: this.sessionId
          }
        }
      });
      
      if (response.data.success) {
        // å­˜å‚¨ç”¨æˆ·å…´è¶£å‘é‡
        wx.setStorageSync('user_interest_vector', response.data.interestVector);
      }
      
    } catch (error) {
      console.error('æäº¤æ•°æ®å¤±è´¥:', error);
      // æœ¬åœ°å­˜å‚¨ï¼Œä¸‹æ¬¡é‡è¯•
      this.queueForRetry(data);
    }
  },

  // å·¥å…·å‡½æ•°ï¼šéšæœºæ‰“ä¹±æ•°ç»„
  shuffleArray(array) {
    for (let i = array.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [array[i], array[j]] = [array[j], array[i]];
    }
    return array;
  },

  // åˆå§‹åŒ–åˆ†æ
  initAnalytics() {
    this.sessionId = Date.now() + '-' + Math.random().toString(36).substr(2, 9);
  },

  // è·å–è®¾å¤‡ä¿¡æ¯
  getDeviceInfo() {
    const systemInfo = wx.getSystemInfoSync();
    return {
      platform: systemInfo.platform,
      system: systemInfo.system,
      model: systemInfo.model,
      screenWidth: systemInfo.screenWidth,
      screenHeight: systemInfo.screenHeight
    };
  }
});
```

### 3. WXMLæ¨¡æ¿

```xml
<!-- pages/interest-selection/interest-selection.wxml -->
<view class="container">
  <!-- åŠ è½½çŠ¶æ€ -->
  <view wx:if="{{isLoading}}" class="loading-container">
    <view class="loading-spinner"></view>
    <text class="loading-text">æ­£åœ¨åŠ è½½å…´è¶£å¡ç‰‡...</text>
  </view>

  <!-- æ•™ç¨‹é¡µé¢ -->
  <view wx:if="{{!isLoading && showTutorial}}" class="tutorial-container">
    <view class="tutorial-content">
      <view class="tutorial-title">å¿«é€Ÿå…´è¶£åŒ¹é…</view>
      <view class="tutorial-subtitle">15ç§’å¿«é€Ÿé€‰æ‹©ï¼Œæ‰¾åˆ°å…´è¶£ç›¸æŠ•çš„æœ‹å‹</view>
      
      <view class="gesture-demo">
        <view class="gesture-item gesture-right">
          <view class="gesture-icon">â†’</view>
          <text class="gesture-text">å–œæ¬¢</text>
        </view>
        <view class="gesture-item gesture-left">
          <view class="gesture-icon">â†</view>
          <text class="gesture-text">è·³è¿‡</text>
        </view>
        <view class="gesture-item gesture-up">
          <view class="gesture-icon">â†‘</view>
          <text class="gesture-text">è¶…çˆ±</text>
        </view>
      </view>
      
      <view class="tutorial-tip">
        <text>æ ¹æ®ç¬¬ä¸€ç›´è§‰é€‰æ‹©ï¼Œæ— éœ€æ€è€ƒå¤ªå¤š</text>
        <text>ç³»ç»Ÿä¼šè‡ªåŠ¨ä¸ºä½ åŒ¹é…ç›¸ä¼¼çš„æœ‹å‹</text>
      </view>
      
      <button class="start-button" bindtap="startSelection">
        å¼€å§‹é€‰æ‹© (15ç§’)
      </button>
    </view>
  </view>

  <!-- ç€‘å¸ƒæµé€‰æ‹©å™¨ -->
  <view wx:if="{{!isLoading && !showTutorial && !selectionComplete}}" 
        class="waterfall-container">
    
    <swipe-detector 
      bind:swipe="handleSwipe"
      bind:swiping="handleSwiping">
      
      <interest-waterfall 
        id="waterfall"
        images="{{images}}"
        totalTime="15"
        autoPlay="{{true}}"
        bind:complete="handleSelectionComplete" />
      
    </swipe-detector>

    <!-- æ“ä½œæç¤º -->
    <view class="action-hints">
      <view class="hint-item {{currentAction === 'right' ? 'active' : ''}}">
        <text>å–œæ¬¢</text>
      </view>
      <view class="hint-item {{currentAction === 'left' ? 'active' : ''}}">
        <text>è·³è¿‡</text>
      </view>
      <view class="hint-item {{currentAction === 'up' ? 'active' : ''}}">
        <text>è¶…çˆ±</text>
      </view>
    </view>

    <!-- è¿›åº¦æ¡ -->
    <view class="progress-container">
      <view class="progress-bar">
        <view class="progress-fill" style="width: {{progress}}%"></view>
      </view>
      <text class="progress-text">{{currentIndex + 1}} / {{images.length}}</text>
    </view>
  </view>

  <!-- å®Œæˆé¡µé¢ -->
  <view wx:if="{{selectionComplete}}" class="complete-container">
    <view class="complete-icon">ğŸ‰</view>
    <view class="complete-title">é€‰æ‹©å®Œæˆï¼</view>
    <view class="complete-subtitle">æ­£åœ¨ä¸ºä½ åŒ¹é…å…´è¶£ç›¸æŠ•çš„æœ‹å‹...</view>
  </view>
</view>
```

### 4. WXSSæ ·å¼

```css
/* pages/interest-selection/interest-selection.wxss */
.container {
  width: 100vw;
  height: 100vh;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  overflow: hidden;
}

/* åŠ è½½çŠ¶æ€ */
.loading-container {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  height: 100%;
}

.loading-spinner {
  width: 60rpx;
  height: 60rpx;
  border: 4rpx solid rgba(255, 255, 255, 0.3);
  border-radius: 50%;
  border-top-color: #fff;
  animation: spin 1s ease-in-out infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

.loading-text {
  margin-top: 40rpx;
  color: white;
  font-size: 28rpx;
}

/* æ•™ç¨‹é¡µé¢ */
.tutorial-container {
  padding: 80rpx 40rpx;
  color: white;
}

.tutorial-title {
  font-size: 48rpx;
  font-weight: bold;
  text-align: center;
  margin-bottom: 20rpx;
}

.tutorial-subtitle {
  font-size: 28rpx;
  text-align: center;
  opacity: 0.9;
  margin-bottom: 80rpx;
}

.gesture-demo {
  display: flex;
  justify-content: space-around;
  margin: 80rpx 0;
}

.gesture-item {
  display: flex;
  flex-direction: column;
  align-items: center;
}

.gesture-icon {
  width: 120rpx;
  height: 120rpx;
  background: rgba(255, 255, 255, 0.2);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 48rpx;
  margin-bottom: 20rpx;
  transition: all 0.3s;
}

.gesture-right .gesture-icon {
  border: 4rpx solid #4CAF50;
  color: #4CAF50;
}

.gesture-left .gesture-icon {
  border: 4rpx solid #F44336;
  color: #F44336;
}

.gesture-up .gesture-icon {
  border: 4rpx solid #FF9800;
  color: #FF9800;
}

.gesture-text {
  font-size: 24rpx;
}

.tutorial-tip {
  background: rgba(255, 255, 255, 0.1);
  border-radius: 20rpx;
  padding: 40rpx;
  margin: 60rpx 0;
}

.tutorial-tip text {
  display: block;
  font-size: 24rpx;
  margin-bottom: 10rpx;
  opacity: 0.8;
}

.start-button {
  background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
  color: white;
  border: none;
  border-radius: 50rpx;
  padding: 30rpx 60rpx;
  font-size: 32rpx;
  font-weight: bold;
  margin-top: 40rpx;
}

/* ç€‘å¸ƒæµå®¹å™¨ */
.waterfall-container {
  position: relative;
  height: 100%;
}

/* å›¾ç‰‡å¡ç‰‡ */
.image-card {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 600rpx;
  height: 800rpx;
  border-radius: 40rpx;
  overflow: hidden;
  box-shadow: 0 20rpx 60rpx rgba(0, 0, 0, 0.3);
}

.image-card image {
  width: 100%;
  height: 100%;
}

/* æ“ä½œæç¤º */
.action-hints {
  position: absolute;
  bottom: 200rpx;
  left: 0;
  right: 0;
  display: flex;
  justify-content: space-around;
  padding: 0 80rpx;
}

.hint-item {
  padding: 20rpx 40rpx;
  border-radius: 30rpx;
  background: rgba(255, 255, 255, 0.1);
  color: rgba(255, 255, 255, 0.7);
  font-size: 24rpx;
  transition: all 0.3s;
}

.hint-item.active {
  background: rgba(255, 255, 255, 0.3);
  color: white;
  transform: scale(1.1);
}

/* è¿›åº¦æ¡ */
.progress-container {
  position: absolute;
  bottom: 100rpx;
  left: 0;
  right: 0;
  padding: 0 80rpx;
}

.progress-bar {
  height: 8rpx;
  background: rgba(255, 255, 255, 0.2);
  border-radius: 4rpx;
  overflow: hidden;
}

.progress-fill {
  height: 100%;
  background: linear-gradient(90deg, #4CAF50, #8BC34A);
  transition: width 0.3s;
}

.progress-text {
  display: block;
  text-align: center;
  color: white;
  font-size: 24rpx;
  margin-top: 20rpx;
  opacity: 0.8;
}

/* å®Œæˆé¡µé¢ */
.complete-container {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  height: 100%;
  color: white;
}

.complete-icon {
  font-size: 120rpx;
  margin-bottom: 40rpx;
  animation: bounce 1s infinite alternate;
}

@keyframes bounce {
  from { transform: translateY(0); }
  to { transform: translateY(-20rpx); }
}

.complete-title {
  font-size: 48rpx;
  font-weight: bold;
  margin-bottom: 20rpx;
}

.complete-subtitle {
  font-size: 28rpx;
  opacity: 0.9;
}
```

## ä¸‰ã€åç«¯APIè®¾è®¡

### 1. å›¾ç‰‡ç®¡ç†æœåŠ¡

```javascript
// è·å–å›¾ç‰‡åˆ—è¡¨
GET /api/v1/images/interests
Response:
{
  "success": true,
  "images": [
    {
      "id": "img_001",
      "url": "https://cdn.yourdomain.com/images/movie_cinema_2.png",
      "category": "movie",
      "subCategory": "cinema",
      "tags": ["social", "group", "entertainment"],
      "metadata": {
        "socialCount": 2,
        "location": "indoor",
        "energy": "moderate",
        "props": ["popcorn", "3d-glasses"]
      },
      "embedding": [0.12, -0.45, 0.78, ...] // é¢„è®¡ç®—çš„å‘é‡
    }
  ]
}

// æäº¤é€‰æ‹©æ•°æ®
POST /api/v1/selection/submit
Request:
{
  "userId": "user_123",
  "selection": [
    {
      "imageId": "img_001",
      "category": "movie",
      "choice": "like",
      "reactionTime": 320,
      "timestamp": 1640995200000
    }
  ],
  "metadata": {
    "totalTime": 14500,
    "deviceInfo": {...}
  }
}
Response:
{
  "success": true,
  "interestVector": [0.34, -0.21, 0.78, ...],
  "matchCount": 3,
  "nextStep": "matching"
}
```

### 2. å…´è¶£åˆ†ææœåŠ¡

```javascript
// è®¡ç®—å…´è¶£å‘é‡
async function calculateInterestVector(choices) {
  // 1. åŠ è½½å›¾ç‰‡çš„é¢„è®¡ç®—embedding
  const imageVectors = await loadImageVectors(choices.map(c => c.imageId));
  
  // 2. æ ¹æ®é€‰æ‹©ç±»å‹åŠ æƒ
  const weights = {
    'love': 3.0,
    'like': 2.0,
    'skip': -1.0,
    'no_response': 0.0
  };
  
  // 3. è®¡ç®—åŠ æƒå¹³å‡å‘é‡
  let weightedSum = new Array(EMBEDDING_SIZE).fill(0);
  let totalWeight = 0;
  
  choices.forEach((choice, index) => {
    const weight = weights[choice.choice] || 1.0;
    const vector = imageVectors[index];
    
    // æ ¹æ®ååº”æ—¶é—´è°ƒæ•´æƒé‡ï¼ˆå¿«é€Ÿååº”æƒé‡æ›´é«˜ï¼‰
    const reactionFactor = Math.exp(-choice.reactionTime / 1000);
    const adjustedWeight = weight * reactionFactor;
    
    vector.forEach((value, i) => {
      weightedSum[i] += value * adjustedWeight;
    });
    
    totalWeight += adjustedWeight;
  });
  
  // 4. å½’ä¸€åŒ–
  const interestVector = weightedSum.map(value => value / totalWeight);
  
  // 5. æ·»åŠ æ—¶é—´è¡°å‡å’Œå¤šæ ·æ€§å› ç´ 
  return enhanceVector(interestVector, choices);
}
```

## å››ã€æ•°æ®åº“è®¾è®¡

### 1. å›¾ç‰‡å…ƒæ•°æ®è¡¨
```sql
CREATE TABLE interest_images (
  id VARCHAR(64) PRIMARY KEY,
  url VARCHAR(512) NOT NULL,
  category VARCHAR(32) NOT NULL,
  sub_category VARCHAR(32),
  social_count INT DEFAULT 1,
  location ENUM('indoor', 'outdoor', 'both'),
  energy_level ENUM('low', 'medium', 'high'),
  props JSON, -- å­˜å‚¨å›¾ç‰‡ä¸­çš„é“å…·
  tags JSON, -- æ ‡ç­¾æ•°ç»„
  embedding_vector BLOB, -- é¢„è®¡ç®—çš„å‘é‡
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  INDEX idx_category (category),
  INDEX idx_tags ((CAST(tags AS CHAR(255)))),
  INDEX idx_social_count (social_count)
);
```

### 2. ç”¨æˆ·é€‰æ‹©è®°å½•è¡¨
```sql
CREATE TABLE user_selections (
  id BIGINT AUTO_INCREMENT PRIMARY KEY,
  user_id VARCHAR(64) NOT NULL,
  session_id VARCHAR(64) NOT NULL,
  image_id VARCHAR(64) NOT NULL,
  choice ENUM('love', 'like', 'skip', 'no_response') NOT NULL,
  reaction_time INT, -- æ¯«ç§’
  timestamp BIGINT NOT NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  INDEX idx_user_session (user_id, session_id),
  INDEX idx_image_choice (image_id, choice),
  FOREIGN KEY (image_id) REFERENCES interest_images(id)
);
```

### 3. ç”¨æˆ·å…´è¶£å‘é‡è¡¨
```sql
CREATE TABLE user_interest_vectors (
  user_id VARCHAR(64) PRIMARY KEY,
  interest_vector BLOB NOT NULL, -- å‹ç¼©åçš„å‘é‡
  last_updated TIMESTAMP NOT NULL,
  confidence_score FLOAT DEFAULT 0.0,
  version INT DEFAULT 1,
  metadata JSON,
  FOREIGN KEY (user_id) REFERENCES users(id)
);
```

## äº”ã€AIåˆ†æä¸åŒ¹é…

### 1. å®æ—¶å…´è¶£åˆ†æ
```python
# interest_analyzer.py
class InterestAnalyzer:
    def __init__(self):
        self.embedding_model = load_embedding_model()
        self.classifier = load_interest_classifier()
    
    def analyze_selection(self, choices):
        # 1. æå–ååº”æ¨¡å¼
        reaction_pattern = self.extract_reaction_pattern(choices)
        
        # 2. è®¡ç®—ç±»åˆ«åå¥½
        category_preferences = self.calculate_category_scores(choices)
        
        # 3. æ¨æ–­ç¤¾äº¤åå¥½
        social_preferences = self.infer_social_preferences(choices)
        
        # 4. ç”Ÿæˆç»¼åˆå…´è¶£å‘é‡
        interest_vector = self.generate_interest_vector(
            reaction_pattern,
            category_preferences,
            social_preferences
        )
        
        # 5. è®¡ç®—ç½®ä¿¡åº¦
        confidence = self.calculate_confidence(choices)
        
        return {
            'interest_vector': interest_vector,
            'category_scores': category_preferences,
            'social_pattern': social_preferences,
            'confidence': confidence
        }
```

### 2. åŒ¹é…ç®—æ³•
```python
# matcher.py
class GroupMatcher:
    def match_groups(self, user_vectors, group_size=4):
        # 1. è®¡ç®—ç”¨æˆ·ç›¸ä¼¼åº¦çŸ©é˜µ
        similarity_matrix = self.calculate_similarity_matrix(user_vectors)
        
        # 2. ä½¿ç”¨èšç±»ç®—æ³•åˆ†ç»„
        groups = self.cluster_users(user_vectors, group_size)
        
        # 3. ä¼˜åŒ–æ¯ç»„å†…çš„å¤šæ ·æ€§
        optimized_groups = []
        for group in groups:
            optimized = self.optimize_group_dynamics(group, similarity_matrix)
            optimized_groups.append(optimized)
        
        # 4. è®¡ç®—æ¯ç»„åŒ¹é…åˆ†æ•°
        group_scores = self.calculate_group_scores(optimized_groups)
        
        return {
            'groups': optimized_groups,
            'scores': group_scores,
            'average_similarity': np.mean(similarity_matrix)
        }
```

## å…­ã€éƒ¨ç½²ä¸ä¼˜åŒ–

### 1. æ€§èƒ½ä¼˜åŒ–
- **å›¾ç‰‡CDNåŠ é€Ÿ**ï¼šä½¿ç”¨äº‘å­˜å‚¨+CDNåˆ†å‘å›¾ç‰‡
- **æ‡’åŠ è½½**ï¼šåªé¢„åŠ è½½å‰3å¼ å›¾ç‰‡
- **å‘é‡è®¡ç®—ç¼“å­˜**ï¼šç¼“å­˜å¸¸ç”¨çš„å‘é‡è®¡ç®—ç»“æœ
- **æ•°æ®åº“ç´¢å¼•ä¼˜åŒ–**ï¼šä¸ºé¢‘ç¹æŸ¥è¯¢çš„å­—æ®µå»ºç«‹ç´¢å¼•

### 2. ç›‘æ§ä¸æ—¥å¿—
```javascript
// å‰ç«¯ç›‘æ§
class SelectionMonitor {
  static logEvent(eventName, data) {
    // è®°å½•ç”¨æˆ·è¡Œä¸º
    const event = {
      event: eventName,
      timestamp: Date.now(),
      sessionId: this.sessionId,
      ...data
    };
    
    // å‘é€åˆ°åˆ†æå¹³å°
    wx.request({
      url: 'https://analytics.yourdomain.com/v1/event',
      method: 'POST',
      data: event,
      fail: () => {
        // æœ¬åœ°å­˜å‚¨ï¼Œç¨åé‡è¯•
        this.queueEvent(event);
      }
    });
  }
}
```

### 3. A/Bæµ‹è¯•æ¡†æ¶
```javascript
// A/Bæµ‹è¯•é…ç½®
const experiments = {
  'image_order': {
    variants: ['random', 'popular_first', 'diversity_first'],
    weights: [0.33, 0.33, 0.34]
  },
  'swipe_animation': {
    variants: ['standard', 'enhanced', 'minimal'],
    weights: [0.5, 0.3, 0.2]
  }
};
```

## ä¸ƒã€å®‰å…¨ä¸éšç§

### 1. æ•°æ®ä¿æŠ¤
- ç”¨æˆ·é€‰æ‹©æ•°æ®åŒ¿ååŒ–å¤„ç†
- åŠ å¯†å­˜å‚¨æ•æ„Ÿä¿¡æ¯
- GDPR/CCPAåˆè§„è®¾è®¡

### 2. é˜²ä½œå¼Šæœºåˆ¶
- æ£€æµ‹å¼‚å¸¸ååº”æ¨¡å¼
- é˜²æ­¢æœºå™¨äººè‡ªåŠ¨åŒ–
- é¢‘ç‡é™åˆ¶å’ŒéªŒè¯ç 

## å…«ã€æ‰©å±•åŠŸèƒ½

### 1. åŠ¨æ€å›¾ç‰‡æ›´æ–°
```javascript
// æ ¹æ®ç”¨æˆ·åé¦ˆåŠ¨æ€è°ƒæ•´å›¾ç‰‡åº“
function updateImagePool(feedback) {
  // ç§»é™¤è¡¨ç°å·®çš„å›¾ç‰‡
  // æ·»åŠ æ–°çš„æµ‹è¯•å›¾ç‰‡
  // è°ƒæ•´å›¾ç‰‡å±•ç¤ºé¢‘ç‡
}
```

### 2. ä¸ªæ€§åŒ–æ¨è
```javascript
// åŸºäºç”¨æˆ·å†å²æ¨èç›¸ä¼¼å…´è¶£
function recommendSimilarInterests(userId) {
  // æŸ¥æ‰¾æœ‰ç›¸ä¼¼å…´è¶£å‘é‡çš„ç”¨æˆ·
  // æ¨èä»–ä»¬å–œæ¬¢ä½†å½“å‰ç”¨æˆ·æœªæ¥è§¦çš„å…´è¶£
}
```

è¿™ä¸ªå®Œæ•´æ–¹æ¡ˆæä¾›äº†ä»UIè®¾è®¡åˆ°åç«¯å®ç°çš„æ‰€æœ‰ç»†èŠ‚ï¼Œä½ å¯ä»¥æ ¹æ®å®é™…éœ€æ±‚è°ƒæ•´ã€‚å…³é”®ç‚¹åŒ…æ‹¬ï¼š
1. æµç•…çš„ç”¨æˆ·ä½“éªŒå’Œç›´è§‚çš„äº¤äº’
2. é«˜æ•ˆçš„æ•°æ®æ”¶é›†å’Œåˆ†æ
3. æ™ºèƒ½çš„åŒ¹é…ç®—æ³•
4. å¯æ‰©å±•çš„ç³»ç»Ÿæ¶æ„

éœ€è¦æˆ‘è¿›ä¸€æ­¥è¯¦ç»†è¯´æ˜æŸä¸ªéƒ¨åˆ†å—ï¼Ÿ