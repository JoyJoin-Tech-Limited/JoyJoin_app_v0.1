å’±ä»¬è¿˜åœ¨å’Œè¿™ä¸ª â€œå¼€å‘ç¯å¢ƒæ’ä»¶â€ ç¼ æ–—ã€‚æŠ¥é”™ä¿¡æ¯éå¸¸æ˜ç¡®ï¼šä½ çš„åç«¯æ‰“åŒ…æ–‡ä»¶ dist/index.js å°è¯•åŠ è½½ @vitejs/plugin-reactï¼Œä½†ç”Ÿäº§ç¯å¢ƒé•œåƒé‡Œæ ¹æœ¬æ²¡è£…è¿™ä¸ªåŒ…ã€‚

ğŸš¨ ä¸ºä»€ä¹ˆä¼šä¸€ç›´æŠ¥è¿™ä¸ªé”™ï¼Ÿ
æœ€æ ¹æœ¬çš„åŸå› æ˜¯ï¼šä½ çš„åç«¯ä»£ç ï¼ˆserver/index.tsï¼‰é‡Œâ€œä¸å°å¿ƒâ€å¼•ç”¨äº†å‰ç«¯çš„é…ç½®æ–‡ä»¶ã€‚

é€šå¸¸åœ¨è¿™æ ·çš„å…¨æ ˆé¡¹ç›®ä¸­ï¼Œåç«¯ä¼šæœ‰ä¸€æ®µä»£ç æ¥å¯åŠ¨ Vite çš„å¼€å‘ä¸­é—´ä»¶ã€‚å¾ˆå¤šæ¨¡æ¿ä¼šå†™æˆè¿™æ ·ï¼š

TypeScript

// âŒ å¯¼è‡´æŠ¥é”™çš„å…ƒå‡¶ï¼š
import viteConfig from '../vite.config'; // è¿™è¡Œä¸€å†™ï¼Œæ‰“åŒ…å·¥å…·å°±ä¼šæŠŠ vite.config ä¹Ÿæ‰“è¿›æ¥
è€Œ vite.config.ts é‡Œé¢å¿…ç„¶å¼•ç”¨äº† @vitejs/plugin-reactã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆå“ªæ€•ä½ æ˜¯åœ¨è¿è¡Œåç«¯ï¼Œå®ƒä¹Ÿä¼šå»ç¿»è¿™ä¸ªæ’ä»¶ã€‚

ğŸ› ï¸ ç»ˆæè§£å†³æ–¹æ¡ˆï¼šä»£ç å½»åº•å»è€¦
æˆ‘ä»¬éœ€è¦ç¡®ä¿åœ¨ ç”Ÿäº§æ¨¡å¼ï¼ˆProductionï¼‰ ä¸‹ï¼Œåç«¯ä»£ç è¿ @vitejs/plugin-react çš„åå­—éƒ½çœ‹ä¸è§ã€‚

1. ä¿®æ”¹ server/index.tsï¼ˆæˆ–åç«¯ä¸»æ–‡ä»¶ï¼‰
ä¸è¦åœ¨é¡¶éƒ¨ä½¿ç”¨é™æ€ import å¼•ç”¨ä»»ä½•å¼€å‘å·¥å…·ã€‚è¯·æŒ‰ç…§ä¸‹é¢çš„é€»è¾‘ä¿®æ”¹ï¼š

TypeScript

// âœ… 1. æ‰€æœ‰çš„ Vite ç›¸å…³å¼•ç”¨éƒ½è¦æ”¾è¿›è¿™ä¸ªåˆ¤æ–­é‡Œ
if (process.env.NODE_ENV !== 'production') {
  // ä½¿ç”¨åŠ¨æ€ import() é¿å… esbuild åœ¨æ„å»ºæ—¶å¼ºåˆ¶å…³è”ä¾èµ–
  const { createServer } = await import('vite');
  
  // âŒ ä¸è¦ç›´æ¥ import viteConfig from '../vite.config'
  // âœ… æ”¹ä¸ºç›´æ¥åœ¨ä»£ç é‡Œå†™ç®€å•çš„é…ç½®ï¼Œæˆ–è€…åŠ¨æ€åŠ è½½
  const vite = await createServer({
    server: { middlewareMode: true },
    appType: 'custom',
    // å¦‚æœä¸€å®šè¦ç”¨ vite.configï¼Œä¹Ÿå¿…é¡»åŠ¨æ€ import
    // configFile: './vite.config.ts' 
  });
  
  app.use(vite.middlewares);
} else {
  // âœ… 2. ç”Ÿäº§ç¯å¢ƒï¼šåªç®¡æ‰˜ç®¡é™æ€æ–‡ä»¶ï¼Œå®Œå…¨ä¸ç¢° Vite
  const express = (await import('express')).default;
  const path = (await import('path')).default;
  
  // ç¡®ä¿è¿™é‡Œçš„è·¯å¾„æŒ‡å‘ä½  Docker é•œåƒé‡Œå­˜æ”¾å‰ç«¯é™æ€æ–‡ä»¶çš„ä½ç½®
  app.use(express.static(path.resolve('dist/public')));
}
2. ä¿®æ”¹ package.json çš„æ„å»ºå‘½ä»¤
åœ¨ esbuild æ‰“åŒ…æ—¶ï¼Œæ˜ç¡®å‘Šè¯‰å®ƒï¼šâ€œçœ‹åˆ°è¿™äº›åŒ…ï¼Œåˆ«ç®¡å®ƒä»¬ï¼Œä¹Ÿåˆ«æŠŠå®ƒä»¬æ‰“è¿›æ¥â€ã€‚

JSON

"scripts": {
  "build": "vite build && esbuild server/index.ts --bundle --platform=node --format=esm --outdir=dist --external:vite --external:@vitejs/* --external:bcrypt"
}
--external:@vitejs/*ï¼šè¿™è¡Œä¼šå¼ºåˆ¶æ’é™¤æ‰€æœ‰ä»¥ @vitejs/ å¼€å¤´çš„æ’ä»¶ã€‚

ğŸ’¡ ä¸ºä»€ä¹ˆç°åœ¨æ‰å‡ºé—®é¢˜ï¼Ÿ
æœ¬åœ°æµ‹è¯•æ—¶ï¼šä½ è¿è¡Œçš„æ˜¯å…¨é‡å®‰è£…çš„ node_modulesï¼Œé‡Œé¢æœ‰ plugin-reactã€‚

äº‘ç«¯éƒ¨ç½²æ—¶ï¼šDockerfile é‡Œçš„ npm ci --only=production åˆ é™¤äº†æ‰€æœ‰å¼€å‘ä¾èµ–ï¼ˆdevDependenciesï¼‰ã€‚

ç»“æœï¼šdist/index.js å¯åŠ¨æ—¶ï¼ŒNode.js å‘ç°ä»£ç é‡Œå†™äº†è¦æ‰¾è¿™ä¸ªæ’ä»¶ï¼Œä½†è¡Œæç®±ï¼ˆé•œåƒï¼‰é‡Œæ²¡è£…ï¼Œäºæ˜¯ç›´æ¥ç½¢å·¥ã€‚

âœ… ä½ ç°åœ¨è¯¥åšçš„äº‹ï¼š
å…¨å±€æœç´¢ï¼šåœ¨ server æ–‡ä»¶å¤¹é‡Œæœç´¢ @vitejs/plugin-react æˆ– vite.configã€‚

æ¸…ç†å¼•ç”¨ï¼šç¡®ä¿ç”Ÿäº§ç¯å¢ƒä¸‹ï¼Œæ²¡æœ‰ä»»ä½•ä»£ç è·¯å¾„ä¼šè§¦å‘å¯¹è¿™äº›åŒ…çš„è®¿é—®ã€‚

æœ¬åœ°é¢„æ ¡éªŒï¼ˆéå¸¸é‡è¦ï¼‰ï¼š åœ¨ä½ çš„æœ¬åœ°ç”µè„‘ä¸Šï¼Œå°è¯•è¿è¡Œï¼š

Bash

NODE_ENV=production node dist/index.js
å¦‚æœæœ¬åœ°ä¹ŸæŠ¥é”™ï¼Œè¯´æ˜ä»£ç è¿˜æ²¡æ”¹å¹²å‡€ã€‚ åªæœ‰æœ¬åœ°è¿™æ ·è¿è¡Œä¸æŠ¥é”™ï¼Œäº‘ç«¯æ‰èƒ½è·‘é€šã€‚

å¦‚æœè¿˜æ˜¯æŠ¥é”™ï¼Œè¯·æŠŠä½  server/index.ts é¡¶éƒ¨çš„ import éƒ¨åˆ†è´´å‡ºæ¥ï¼Œæˆ‘ç›´æ¥å¸®ä½ äººå·¥èµ°è¯»ä¸€ä¸‹ä»£ç ã€‚