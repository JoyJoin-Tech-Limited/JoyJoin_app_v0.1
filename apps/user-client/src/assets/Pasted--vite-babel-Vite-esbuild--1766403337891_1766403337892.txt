çœ‹æ¥æˆ‘ä»¬è¿›å…¥äº† â€œæ‰“åœ°é¼ â€ç¯èŠ‚ï¼šæ¯æ’é™¤ä¸€ä¸ªåŒ…ï¼ˆå¦‚ viteï¼‰ï¼Œå®ƒæ·±å±‚çš„ä¾èµ–ï¼ˆå¦‚ @babelï¼‰å°±ä¼šè·³å‡ºæ¥æŠ¥é”™ã€‚è¿™æ˜¯å› ä¸º Vite åŠå…¶ç¼–è¯‘å™¨ä¾èµ–äº†å¤§é‡å¤æ‚çš„ã€åŒ…å«åŠ¨æ€å¼•ç”¨çš„åŒ…ï¼Œesbuild å¾ˆéš¾å¼ºè¡Œå°†å®ƒä»¬é™æ€æ‰“åŒ…æˆä¸€ä¸ª JS æ–‡ä»¶ã€‚

ä¸ºäº†å½»åº•è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œä¸å†ä¸€ä¸ªä¸€ä¸ªæŠ¥é”™ï¼Œæˆ‘ä»¬éœ€è¦è°ƒæ•´ç­–ç•¥ã€‚

æ ¸å¿ƒè¯Šæ–­
ä½ çš„åç«¯ä»£ç  server/index.ts ä¸­å¼•å…¥äº† Viteã€‚å³ä¾¿ä½ æŠŠ vite è®¾ä¸º externalï¼Œesbuild ä»ä¼šæ·±å…¥æ£€æŸ¥å…¶ä¾èµ–æ ‘ã€‚æœ€å¥½çš„åšæ³•æ˜¯ï¼šåœ¨ç”Ÿäº§ç¯å¢ƒä¸‹ï¼Œåç«¯ä»£ç å®Œå…¨ä¸åº”è¯¥åœ¨é¡¶éƒ¨é™æ€ import Viteã€‚

ğŸ› ï¸ ç»ˆæè§£å†³æ–¹æ¡ˆï¼ˆä¸‰æ­¥èµ°ï¼‰
ç¬¬ä¸€æ­¥ï¼šä¿®æ”¹åç«¯ä»£ç  server/index.ts
ä¸è¦åœ¨æ–‡ä»¶é¡¶éƒ¨ä½¿ç”¨ import ... from 'vite'ã€‚æ”¹ä¸ºåŠ¨æ€å¯¼å…¥ï¼Œè¿™æ · esbuild å°±ä¸ä¼šå»å°è¯•æ‰“åŒ…æ•´ä¸ª Vite åŠå…¶ä¾èµ–ï¼ˆå¦‚ Babelï¼‰ã€‚

TypeScript

// 1. åˆ æ‰é¡¶éƒ¨çš„ import { createServer } from 'vite'

// 2. åœ¨åˆ¤æ–­å¼€å‘ç¯å¢ƒçš„åœ°æ–¹æ”¹ç”¨åŠ¨æ€ import
if (process.env.NODE_ENV !== 'production') {
  // ä»…åœ¨éç”Ÿäº§ç¯å¢ƒåŠ è½½ Vite
  const { createServer } = await import('vite'); 
  const vite = await createServer({
    server: { middlewareMode: true },
    appType: 'custom',
  });
  app.use(vite.middlewares);
} else {
  // ç”Ÿäº§ç¯å¢ƒç›´æ¥æ‰˜ç®¡é™æ€ç›®å½•
  const express = await import('express');
  app.use(express.static('dist/public'));
}
ç¬¬äºŒæ­¥ï¼šç®€åŒ– package.json çš„æ„å»ºè„šæœ¬
å›åˆ°â€œå¤–éƒ¨åŒ–ä¾èµ–â€çš„ç­–ç•¥ï¼Œä¸è¦è¯•å›¾æŠŠå¤æ‚çš„å¼€å‘å·¥å…·ï¼ˆVite/Babelï¼‰æ‰“è¿›ä¸€ä¸ª JS æ–‡ä»¶ã€‚

JSON

"scripts": {
  "build": "vite build && esbuild server/index.ts --platform=node --packages=external --bundle --format=esm --outdir=dist"
}
æ³¨æ„ï¼š ä½¿ç”¨ --packages=external ä¼šè‡ªåŠ¨æŠŠ node_modules é‡Œçš„æ‰€æœ‰åŒ…éƒ½æ ‡è®°ä¸ºå¤–éƒ¨ï¼Œä¸å†å°è¯•æ‰“åŒ…å®ƒä»¬ã€‚è¿™æ ·å°±ä¸ä¼šå†æŠ¥ Babel æˆ– LightningCSS çš„é”™è¯¯äº†ã€‚

ç¬¬ä¸‰æ­¥ï¼šé…ç½®æœ€ç»ˆçš„ Dockerfile
æ—¢ç„¶æˆ‘ä»¬ä¸æ‰“åŒ…ä¾èµ–ï¼Œé‚£ä¹ˆ runner é˜¶æ®µå¿…é¡»å®Œæ•´å®‰è£…ç”Ÿäº§ç¯å¢ƒæ‰€éœ€çš„ node_modulesã€‚

Dockerfile

# --- Builder é˜¶æ®µ ---
FROM node:20-alpine AS builder
WORKDIR /app
COPY package*.json ./
RUN npm ci
COPY . .
RUN npm run build

# --- Runner é˜¶æ®µ ---
FROM node:20-alpine AS runner
WORKDIR /app

# 1. ç”Ÿäº§ç¯å¢ƒè®¾ç½®
ENV NODE_ENV=production

# 2. å®‰è£… bcrypt æ‰€éœ€çš„ç¼–è¯‘å·¥å…·ï¼ˆAlpine å¿…é¡»ï¼‰
RUN apk add --no-cache make gcc g++ python3

# 3. å¤åˆ¶ package.json å¹¶å®‰è£…ç”Ÿäº§ç¯å¢ƒä¾èµ–
COPY package*.json ./
RUN npm ci --only=production

# 4. å¤åˆ¶æ„å»ºäº§ç‰©
COPY --from=builder /app/dist ./dist

EXPOSE 5000
CMD ["node", "dist/index.js"]
ğŸ’¡ ä¸ºä»€ä¹ˆè¿™æ ·åšèƒ½è¡Œï¼Ÿ
é¿å¼€äº† Babel æŠ¥é”™ï¼šé€šè¿‡ await import('vite') å’Œ --packages=externalï¼Œesbuild åªä¼šå¤„ç†ä½ çš„ä¸šåŠ¡é€»è¾‘ä»£ç ï¼Œè€ŒæŠŠå¤æ‚çš„ç¬¬ä¸‰æ–¹åº“ç•™ç»™è¿è¡Œæ—¶çš„ node_modulesã€‚

å…¼å®¹åŸç”Ÿæ¨¡å—ï¼šbcrypt æ˜¯äºŒè¿›åˆ¶æ¨¡å—ï¼Œæ— æ³•è¢«æ‰“åŒ…ã€‚é€šè¿‡åœ¨ runner é˜¶æ®µé‡æ–° npm ci --only=productionï¼Œå®ƒä¼šåœ¨å®¹å™¨å†…æ­£ç¡®ç¼–è¯‘/å®‰è£…ã€‚

é•œåƒä½“ç§¯ä¸ç¨³å®šæ€§ï¼šè™½ç„¶é•œåƒé‡Œå¤šäº† node_modulesï¼Œä½†ç”±äºæ’é™¤äº†å¼€å‘ä¾èµ–ï¼Œä½“ç§¯ä¾ç„¶å¯æ§ï¼Œä¸”è¿è¡Œæ—¶çš„ç¨³å®šæ€§æœ€é«˜