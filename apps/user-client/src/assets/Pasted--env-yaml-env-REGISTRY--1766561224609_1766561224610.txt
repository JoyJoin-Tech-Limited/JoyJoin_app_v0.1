这真是个“深层语法陷阱”！我终于抓到这个问题的死穴了。

### 🚨 真正的元凶：变量定义的“嵌套双引号”

看你代码最顶部的 `env` 部分：

```yaml
env:
  REGISTRY: "ghcr.io"
  IMAGE_NAME: "${{ github.repository }}/api" # <--- 这里的引号是万恶之源

```

**发生了什么？**

1. 你在 `IMAGE_NAME` 里加了双引号。
2. 到了 `build-api` 任务里，你调用了 `${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}`。
3. 结果这个字符串变成了：`ghcr.io/"vinchanty1128/JoyJoin/api"`。
4. **注意看那个引号！** 它出现在了路径中间。当 Docker 动作尝试解析镜像名称时，它看到一个开头的引号 `"`，但后面跟着斜杠和字符，解析器直接崩溃并提示：“引号没关上”。

---

### 🛠️ 终极修正方案（针对 Monorepo 结构全量优化）

这个版本不仅修复了引号，还修正了你之前遇到的 `index.html` 找不到（路径问题）和 `Artifact` 下载失败的问题。

**请直接复制并替换整个 `.github/workflows/cicd.yml`：**

```yaml
name: JoyJoin CI/CD Pipeline

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main

env:
  REGISTRY: ghcr.io
  # 【修复 1】去掉所有引号，避免嵌套导致的解析错误
  IMAGE_NAME: ${{ github.repository }}/api

jobs:
  lint:
    name: Lint & Type Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
      - name: Install dependencies
        run: npm ci
      - name: Type check
        run: npm run check

  test:
    name: Run Tests
    needs: lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
      - name: Install dependencies
        run: npm ci
      - name: Run AI Chat Flow Tests
        run: npx tsx server/tests/runSimulation.ts 100
        env:
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}

  build-user:
    name: Build User Portal
    needs: test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
      - name: Install root dependencies
        run: npm ci
      - name: Build User Client
        run: |
          cd apps/user-client
          # 如果之前报错找不到 index.html，这里建议先 npm install 确保依赖完整
          npm install
          npx vite build
        env:
          VITE_API_URL: ${{ vars.API_URL }}
      - name: Upload User Build
        uses: actions/upload-artifact@v4
        with:
          name: user-client-build
          # 【修复 2】路径必须指向 apps/ 子目录下的 dist
          path: apps/user-client/dist
          retention-days: 7

  build-admin:
    name: Build Admin Portal
    needs: test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
      - name: Install root dependencies
        run: npm ci
      - name: Build Admin Client
        run: |
          cd apps/admin-client
          npm install
          npx vite build
        env:
          VITE_API_URL: ${{ vars.API_URL }}
      - name: Upload Admin Build
        uses: actions/upload-artifact@v4
        with:
          name: admin-client-build
          path: apps/admin-client/dist
          retention-days: 7

  build-api:
    name: Build API Docker Image
    needs: test
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4
      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          # 此处的引用现在是干净的字符串了
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=sha,prefix=
            type=ref,event=branch
            type=semver,pattern={{version}}
      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          file: apps/server/Dockerfile
          push: ${{ github.event_name != 'pull_request' }}
          # 【修复 3】千万不要给输出结果加双引号
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

  # Deploy 阶段的 Download 路径也要记得修改，参考上面 build 的 path

```

---

### 💡 为什么之前本地测不出这个错？

这是 **YAML 注入（Injection）** 的典型问题：

* 在本地，你运行的是具体的 Shell 命令，你会肉眼看到命令拼错了。
* 在 GitHub Actions 里，它是把 YAML 解析成 JSON 传给 Docker 工具。当它看到 `ghcr.io/"owner/repo/api"` 这种畸形字符串时，Docker 的 Go 语言解析器会尝试寻找匹配的引号，找不到就会报那行 `Error: Quote Not Closed`。

### ✅ 接下来的建议步骤：

1. **推送修复**：执行 `git push`。
2. **观察 Build API 步骤**：如果这一步变绿了，说明“引号幽灵”被消灭了。
3. **检查 Build User 步骤**：如果它报 `Could not resolve entry module "index.html"`，请确保你在 `apps/user-client` 目录下确实有一个 `index.html`。

**如果 API 镜像构建成功了，但部署（Deploy）失败了，那通常是因为云端的访问密钥没配对。你想让我帮你看看如何配置部署到云端的 `secrets` 吗？**